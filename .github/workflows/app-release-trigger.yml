name: App Release Trigger

on:
  repository_dispatch:
    types: [app-release]

permissions:
  contents: write
  packages: read

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Debug payload
        run: |
          echo "Received payload:"
          echo "version: '${{ github.event.client_payload.version }}'"
          echo "environment: '${{ github.event.client_payload.environment }}'"
          echo "semantic_version: '${{ github.event.client_payload.semantic_version }}'"
          echo "clean_semver: '${{ github.event.client_payload.clean_semver }}'"
          echo "sha: '${{ github.event.client_payload.sha }}'"
          echo "backend_image: '${{ github.event.client_payload.backend_image }}'"
          echo "frontend_image: '${{ github.event.client_payload.frontend_image }}'"

      - name: Validate payload
        run: |
          # Validate environment
          ENV="${{ github.event.client_payload.environment }}"
          if [[ -z "$ENV" ]]; then
            echo "::error::Environment is empty in payload"
            exit 1
          fi

          if [[ "$ENV" != "stg" && "$ENV" != "prod" ]]; then
            echo "::error::Invalid environment: '$ENV'. Must be 'stg' or 'prod'."
            exit 1
          fi

          # Validate version based on environment
          VERSION="${{ github.event.client_payload.version }}"
          if [[ -z "$VERSION" ]]; then
            echo "::error::Version is empty in payload"
            exit 1
          fi

          # For prod, expect clean SemVer (X.Y.Z)
          if [[ "$ENV" == "prod" ]]; then
            if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "::error::Invalid version format for prod: '$VERSION'. Expected X.Y.Z format."
              exit 1
            fi
          fi

          # For stg, allow SemVer with suffix or stg-<hash>
          if [[ "$ENV" == "stg" ]]; then
            if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-stg)?$ ]] && ! [[ "$VERSION" =~ ^stg-[a-f0-9]+$ ]]; then
              echo "::error::Invalid version format for stg: '$VERSION'. Expected X.Y.Z[-stg] or stg-<hash> format."
              exit 1
            fi
          fi

          echo "Payload validation successful"

      - name: Process tag using local action
        id: process-tag
        uses: ./.github/actions/process-tag
        with:
          raw_version: ${{ github.event.client_payload.version }}
          environment: ${{ github.event.client_payload.environment }}
          semantic_version: ${{ github.event.client_payload.semantic_version }}
          clean_semver: ${{ github.event.client_payload.clean_semver }}
          sha: ${{ github.event.client_payload.sha }}

      - name: Set outputs for backward compatibility
        id: parse
        run: |
          echo "raw_version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          echo "environment=${{ github.event.client_payload.environment }}" >> $GITHUB_OUTPUT
          echo "version=${{ steps.process-tag.outputs.version }}" >> $GITHUB_OUTPUT
          echo "tag_name=${{ steps.process-tag.outputs.tag_name }}" >> $GITHUB_OUTPUT
          echo "git_hash=${{ steps.process-tag.outputs.git_hash }}" >> $GITHUB_OUTPUT
          echo "deploy_tag=${{ steps.process-tag.outputs.deploy_tag }}" >> $GITHUB_OUTPUT

          echo "Using version: ${{ steps.process-tag.outputs.version }}"
          echo "Using tag name: ${{ steps.process-tag.outputs.tag_name }}"
          echo "Using git hash: ${{ steps.process-tag.outputs.git_hash }}"
          echo "Using deploy tag: ${{ steps.process-tag.outputs.deploy_tag }}"

      - name: Handle Git Tag
        # This step now runs unconditionally after tag processing
        id: create_tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          TAG_NAME="${{ steps.parse.outputs.tag_name }}"
          echo "Handling git tag: $TAG_NAME"

          # Check if tag exists remotely
          if git ls-remote --tags origin | grep -q "$TAG_NAME"; then
            echo "Tag $TAG_NAME already exists in remote repository"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            echo "tag_verified=true" >> $GITHUB_OUTPUT
          else
            # Check if tag exists locally
            if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
              echo "Tag $TAG_NAME exists locally but not remotely, deleting and recreating"
              git tag -d "$TAG_NAME"
            fi

            # Create and push tag
            echo "Creating new tag: $TAG_NAME"
            git tag -a "$TAG_NAME" -m "Release $TAG_NAME"

            if git push origin "$TAG_NAME"; then
              echo "Successfully created and pushed tag: $TAG_NAME"
              echo "tag_exists=true" >> $GITHUB_OUTPUT
              echo "tag_verified=true" >> $GITHUB_OUTPUT

              # Add a small delay to ensure the tag is available for the release
              echo "Waiting for tag to be available..."
              sleep 5
            else
              echo "::error::Failed to push tag $TAG_NAME to remote repository"
              echo "tag_exists=false" >> $GITHUB_OUTPUT
              echo "tag_verified=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Create GitHub Release
        # Run if the tag was successfully created or already existed
        if: steps.create_tag.outputs.tag_verified == 'true'
        run: |
          # Use gh CLI to create a release
          echo "Creating GitHub release for tag ${{ steps.parse.outputs.tag_name }}..."

          # Install GitHub CLI if not already installed
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi

          # Authenticate with GitHub CLI
          echo "${{ secrets.MACHINE_USER_TOKEN }}" | gh auth login --with-token

          # Create release notes file
          cat > release_notes.md << EOF
          ## Release Triggered

          This release was triggered for the **${{ steps.parse.outputs.environment }}** environment.

          ### Version Information
          - Release Tag: ${{ steps.parse.outputs.tag_name }}
          - Environment: ${{ steps.parse.outputs.environment }}
          - Original Version Sent: ${{ steps.parse.outputs.raw_version }}
          - Associated Git Hash: ${{ steps.parse.outputs.git_hash }}

          This release event will trigger the `update-helm.yaml` workflow to update the corresponding Helm values.
          EOF

          # Check if release already exists
          if gh release view "${{ steps.parse.outputs.tag_name }}" &>/dev/null; then
            echo "Release ${{ steps.parse.outputs.tag_name }} already exists, updating it..."
            # Update existing release
            gh release edit "${{ steps.parse.outputs.tag_name }}" \
              --title "Release ${{ steps.parse.outputs.tag_name }}" \
              --notes-file release_notes.md \
              ${{ github.event.client_payload.environment == 'stg' && '--prerelease' || '' }}

            # No assets to upload in this workflow anymore
            echo "✅ GitHub release updated successfully!"
          else
            # Create new release without assets first
            if gh release create "${{ steps.parse.outputs.tag_name }}" \
              --title "Release ${{ steps.parse.outputs.tag_name }}" \
              --notes-file release_notes.md \
              --generate-notes \
              ${{ github.event.client_payload.environment == 'stg' && '--prerelease' || '' }}; then

              # No assets to upload in this workflow anymore
              echo "✅ GitHub release created successfully!"
            else
              echo "::warning::Failed to create release, but continuing workflow"
            fi
          fi


      - name: Debug Release Creation
        # Run if the tag was successfully created or already existed
        if: steps.create_tag.outputs.tag_verified == 'true'
        run: |
          echo "A GitHub release was created/updated with tag ${{ steps.parse.outputs.tag_name }}"
          echo "Environment: ${{ steps.parse.outputs.environment }}"
          echo "This should trigger the update-helm.yaml workflow via the release: [published] event."
          echo "If update-helm.yaml doesn't run, check if the release was actually published (not a draft)."
          echo "Staging releases are marked as pre-releases: ${{ steps.parse.outputs.environment == 'stg' }}"
